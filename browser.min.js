(()=>{var b=class extends Error{constructor(t,n){super(t);this.node=n}},g=class extends Error{constructor(t,n){super(t);this.node=n}},A=class extends g{};function U(e,t){return{type:"function",environment:e,body:t}}function p(e){return{type:"native-function",body:e}}function q(e){return e!==null&&typeof e=="object"&&e.type==="function"}function j(e){return e!==null&&typeof e=="object"&&e.type==="native-function"}function N(e){if(typeof e!="object")return String(e);if(e===null)return"null";switch(e.type){case"function":return"[Function]";case"native-function":return"[Native Function]"}}function _(e){return typeof e=="number"?e:parseInt(N(e).trim(),10)}function w(e){return!!e}function I(e,t){return typeof e!="object"||typeof t!="object"||e===null||t===null,e===t}function $(e,t){throw new g(`Variable '${e}' not found`,t)}function H(e,t){throw new g(`Slot '${e}' not found`,t)}function X(e,t,n){throw new g(`Value '${N(t)}' is not ${e}`,n)}function v(e,t){throw new g(`Expected at least ${e} argument${e>1?"s":""}.`,t)}function Y(e){throw new g("Unexpected end of input.",e)}function G(){return{scopes:[]}}function W(e){return{bindings:new Map,functionParameters:e}}function Ae(e,t){let{scopes:n}=e;for(let r=n.length-1;r>=0;r--){let o=n[r]?.bindings.get(t);if(o!==void 0)return o}}function B(e,t,n){let r=Ae(e,t);return r===void 0&&$(t,n),r}function M(e,t,n,r){let o=e.scopes[e.scopes.length-1];if(!o)throw new A("No scope",r);o.bindings.set(t,n)}function z(e,t,n,r){let{scopes:o}=e;for(let i=o.length-1;i>=0;i--){let s=o[i];if(s?.bindings.has(t)){s.bindings.set(t,n);return}}throw new A(`No binding of name '${t}'`,r)}function Be(e,t){let{scopes:n}=e,r=n[n.length-1];return r?r.functionParameters[Number(t)]:void 0}function J(e,t,n){let r=Be(e,t);return r===void 0&&H(t,n),r}function x(e){return e.nodeType===Node.ELEMENT_NODE}function K(e){return e.nodeType===Node.TEXT_NODE||e.nodeType===Node.CDATA_SECTION_NODE}function C(e,t){return t.length>=e}function u(e){return e.length>0}function Q(e){let t="";return{get:async r=>{let o=t.match(r);for(;o===null||!u(o);){let i=await e.input();if(i===void 0)return;t+=i,o=t.match(r)}return t=t.slice(o[0].length),o}}}function R(e){return e}async function Z(e,t){let n=[];for(let r of e)n.push(await t(r));return n}function a(e){if(e===null)return Number.NaN;if(typeof e!="object")return Number(e);switch(e.type){case"function":case"native-function":return Number.NaN}}var ee={plus:p(e=>{let t=0;for(let n of e)t+=a(n);return t}),minus:p(e=>{if(!u(e))return 0;let t=a(e[0]);for(let n of e.slice(1))t-=a(n);return t}),times:p(e=>{let t=1;for(let n of e)t*=a(n);return t}),divide:p(e=>{if(!u(e))return 1;let t=a(e[0]);for(let n of e.slice(1))t/=a(n);return t}),power:p(e=>{if(!u(e))return 1;let t=a(e[0]);for(let n of e.slice(1))t**=a(n);return t}),rem:p((e,t)=>(C(2,e)||v(2,t),a(e[0])%a(e[1]))),gcd:p(e=>{if(!u(e))return 1;let t=a(e[0]);for(let r of e.slice(1))t=n(t,a(r));return t;function n(r,o){for(r<o&&([r,o]=[o,r]);o!==0;)[r,o]=[o,r%o];return r}}),min:p(e=>Math.min(...e.map(a))),max:p(e=>Math.max(...e.map(a))),eq:p((e,t)=>(C(2,e)||v(2,t),+I(e[0],e[1]))),neq:p((e,t)=>(C(2,e)||v(2,t),+!I(e[0],e[1]))),lt:p((e,t)=>{u(e)||v(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o<s))return 0;o=s}return 1}),gt:p((e,t)=>{u(e)||v(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o>s))return 0;o=s}return 1}),leq:p((e,t)=>{u(e)||v(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o<=s))return 0;o=s}return 1}),geq:p((e,t)=>{u(e)||v(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o>=s))return 0;o=s}return 1}),and:p(e=>+e.reduce((t,n)=>t&&w(n),!0)),or:p(e=>+e.reduce((t,n)=>t||w(n),!1)),xor:p(e=>+e.reduce((t,n)=>t?!w(n):w(n),!1)),implies:p((e,t)=>(u(e)||v(1,t),+e.map(w).reduceRight((n,r)=>!r||n))),charcodeat:p(e=>{if(e.length<2)return-1;let t=e[0],n=a(e[1]);return n<0||n>=t.length?-1:t.charCodeAt(n)})};async function c(e,t){switch(e.type){case"OutputExpression":{let n=await c(e.expression,t);return t.io.output(N(n)),n}case"TextExpression":return e.text;case"ConcatExpression":{let n=[];for(let r of e.expressions)n.push(N(await c(r,t)));return n.join("")}case"AbbrExpression":{let n=typeof e.title=="string"?B(t.environment,e.title,e.node):await c(e.title,t),r=await Z(e.parameters,o=>c(o,t));if(q(n))return await Me(n,r,t);if(j(n))return await n.body(r,e.node);X("function",n,e.node)}case"SlotExpression":return J(t.environment,e.name,e.node);case"VarExpression":{let n=await c(e.name,t);return B(t.environment,N(n),e.node)}case"MathBuiltInExpression":return ee[e.name];case"InputExpression":{let n=new RegExp("^"+(e.pattern??".*\\n"),"u");if(e.name===void 0){let r=await t.input.get(n);return r===void 0&&Y(e.node),r[1]??r[0]??null}else{let r=N(B(t.environment,e.name,e.node)),o=n.exec(r);if(o===null||!u(o))return null;let i=o[1]??o[0];return z(t.environment,e.name,r.slice(o[0].length),e.node),i}}case"RubyExpression":{let n=await c(e.expression,t);for(let{condition:r,then:o}of e.branches){let i=await c(r,t);if(I(n,i))return c(o,t)}return e.else?c(e.else,t):null}case"SpanExpression":return c(e.expression,t);case"MeterExpression":return _(await c(e.expression,t));default:R(e)}}async function Me(e,t,n){let r=await te(e.body,n,t);switch(r.type){case"normal":return null;case"footer":return r.value;default:R(r)}}var L={type:"normal"};async function ne(e,t){switch(e.type){case"ExpressionStatement":return await c(e.expression,t),L;case"FooterStatement":{let n=await c(e.expression,t);return{type:"footer",value:n}}case"DefinitionListStatement":{for(let{name:n,value:r}of e.definitions){let o=N(await c(n,t)),i=await c(r,t);M(t.environment,o,i,e.node)}return L}case"SectionDeclaration":return L;default:R(e)}}function ie(e,t){let n=re(e,t.environment,[]),r={...t,environment:n};return oe(e,r)}function te(e,t,n){let r=re(e,t.environment,n),o={...t,environment:r};return oe(e,o)}function re(e,t,n){let r=W(n),o={scopes:[...t.scopes,r]};for(let i of e)switch(i.type){case"SectionDeclaration":{let s=U(o,i.body);M(o,i.title,s,i.node);break}}return o}async function oe(e,t){for(let n of e){let r=await ne(n,t);if(r.type==="footer")return{type:"footer",value:r.value}}return{type:"normal"}}function se(e){return{async run(t){let n={io:e,input:Q(e),environment:G()};await ie(t.statements,n)}}}function ae(e,t){return{type:"OutputExpression",expression:t,node:e}}function D(e,t,n){return{type:"AbbrExpression",title:t,parameters:n,node:e}}function F(e,t){return{type:"TextExpression",text:t,node:e}}function pe(e,t){return{type:"SlotExpression",name:t,node:e}}function ue(e,t){return{type:"VarExpression",name:t,node:e}}function ce(e,t){return{type:"MathBuiltInExpression",name:t,node:e}}function le(e,t,n){return{type:"InputExpression",name:t,pattern:n,node:e}}function P(e,t,n,r){return{type:"RubyExpression",expression:t,branches:n,else:r,node:e}}function k(e,t){return{type:"SpanExpression",expression:t,node:e}}function de(e,t){return{type:"MeterExpression",expression:t,node:e}}function me(e,t){return{type:"ConcatExpression",expressions:t,node:e}}function xe(e){let t=[],n=e.concat([]);for(;n.length>0;){let r=h(n);if(!r)break;let[o,i]=r;t.push(o),n=i;let s=n[0];s&&x(s)&&s.tagName==="BR"&&(n=i.slice(1))}return l(n),t}function d(e){for(let[t,n]of e.entries())switch(n.nodeType){case Node.COMMENT_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.DOCUMENT_TYPE_NODE:continue;case Node.TEXT_NODE:if(!n.nodeValue||/^\s*$/.test(n.nodeValue))continue;default:return t===0?e:e.slice(t)}return[]}function T(e){throw new b("Unexpected node",e)}function m(e,t){throw new b(`Expected ${e}.`,t)}function fe(e,t){throw new b(`Expected an attribute '${e}' to exist.`,t)}function ye(e){let n=d(Array.from(e.childNodes))[0];(n===void 0||!x(n))&&m("an element",e);let r=n.tagName.toLowerCase();return Ce(r)||m("one of: "+Array.from(Ee.values()).join(", "),n),ce(n,r)}var Ee=new Set(["plus","minus","times","divide","rem","power","gcd","min","max","eq","neq","lt","gt","leq","geq","and","or","xor","implies","charcodeat"]);function Ce(e){return console.log(e),Ee.has(e)}function h(e){let t=Ne(e);if(t===void 0)return;let[n,r]=t,o=[n],i=r;for(;;){let E=Ne(i);if(E===void 0)break;let[y,V]=E;o.push(y),i=V}let s=o.length===1?n:me(n.node,o);i=d(i);let f=i[0];return f!==void 0&&x(f)&&f.tagName==="RUBY"?[Fe(f,s),i.slice(1)]:[s,i]}function Ne(e){let t=d(e),n=t[0];if(!!n){if(x(n))switch(n.tagName){case"WBR":return[F(n,`
`),t.slice(1)];case"OUTPUT":{let[r,o]=S(Array.from(n.childNodes),n);return[ae(n,r),t.slice(1)]}case"ABBR":{let r=xe(Array.from(n.childNodes)),o=n.getAttribute("title");if(o===null){let[i,...s]=r;if(i===void 0)throw new b("Expected at least one expressions as children",n);return[D(n,i,s),t.slice(1)]}return[D(n,o,r),t.slice(1)]}case"SLOT":{let r=n.getAttribute("name")??"0";return[pe(n,r),t.slice(1)]}case"VAR":{let[r,o]=S(Array.from(n.childNodes),n);return l(o),[ue(n,r),t.slice(1)]}case"math":return[ye(n),t.slice(1)];case"INPUT":{let r=n.getAttribute("type");r!==null&&r!=="text"&&T(n);let o=n.getAttribute("name")??void 0,i=n.getAttribute("pattern")??void 0;return[le(n,o,i),t.slice(1)]}case"SPAN":{let r=Array.from(n.childNodes),o=h(r);if(o===void 0)return l(r),[k(n,F(n,"")),t.slice(1)];let[i,s]=o;return l(s),[k(n,i),t.slice(1)]}case"METER":{let r=h(Array.from(n.childNodes));r===void 0&&m("some child",n);let[o,i]=r;return l(i),[de(n,o),t.slice(1)]}}else if(K(n))return[F(n,n.nodeValue||""),t.slice(1)]}}function Fe(e,t){let n=d(Array.from(e.childNodes)),r=[];for(;n.length>0;){let o=h(n);if(o!==void 0){let[i,s]=o,f=d(s),E=f[0];(E===void 0||!x(E)||E.tagName!=="RT")&&m("an rt element",E??e);let[y,V]=S(Array.from(E.childNodes),E);l(V),r.push({condition:i,then:y}),n=d(f.slice(1))}else{let i=n[0];(i===void 0||!x(i)||i.tagName!=="RT")&&m("an expression or an rt element",i??e);let[s,f]=S(Array.from(i.childNodes),i);return l(f),P(e,t,r,s)}}return P(e,t,r,void 0)}function S(e,t){let n=h(e);return n===void 0&&m("expression",e[0]||t),n}function l(e){let t=d(e);u(t)&&T(t[0])}function he(e,t){let n=e.getAttribute(t);return n===null&&fe(t,e),n}function ve(e,t){return{type:"ExpressionStatement",expression:t,node:e}}function ge(e,t){return{type:"FooterStatement",expression:t,node:e}}function Se(e,t){return{type:"DefinitionListStatement",definitions:t,node:e}}function be(e,t,n){return{type:"SectionDeclaration",title:t,body:n,node:e}}function we(e){let t=d(e),n=t[0];if(!!n)switch(x(n)||T(n),n.tagName){case"P":{let[r,o]=S(Array.from(n.childNodes),n);return l(o),[ve(n,r),t.slice(1)]}case"FOOTER":{let[r,o]=S(Array.from(n.childNodes),n);return l(o),[ge(n,r),t.slice(1)]}case"DL":{let r=d(Array.from(n.childNodes)),o=[];for(;r.length>0;){let[i,...s]=r;(i===void 0||!x(i)||i.tagName!=="DT")&&m("a dt element",i??n);let[f,E]=h(Array.from(i.childNodes))||m("an element",i);l(E);let[y,...V]=d(s);(y===void 0||!x(y)||y.tagName!=="DD")&&m("a dd element",y??n);let[Ie,Re]=h(Array.from(y.childNodes))||m("an element",y);l(Re),o.push({name:f,value:Ie}),r=d(V)}return[Se(n,o),t.slice(1)]}case"SECTION":{let r=he(n,"title"),o=O(Array.from(n.childNodes));return[be(n,r,o),t.slice(1)]}}}function O(e){let t=[],n=e.concat([]);for(;n.length>0;){let r=we(n);if(!r)break;let[o,i]=r;t.push(o),n=i}return l(n),t}function Te(e){return{statements:O(Array.from(e.childNodes))}}document.readyState!=="loading"?Ve(document.body):document.addEventListener("DOMContentLoaded",()=>{Ve(document.body)});async function Ve(e){let t=document.createElement("main");Oe(e,t);let n=Te(t);console.debug("parsed",n);let{outputContainer:r}=Le();await se({input:async()=>{},output:i=>{console.log(i),r.append(i)}}).run(n)}function Oe(e,t){let n=document.createRange();n.selectNodeContents(e),t.appendChild(n.extractContents())}function Le(){let e=document.createElement("style");e.textContent=`
html, body, pre.output {
  height: 100%;
}
`,document.head.append(e);let t=document.createElement("pre");return t.classList.add("output"),document.body.appendChild(t),{outputContainer:t}}})();
